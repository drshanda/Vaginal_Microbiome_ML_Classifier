---
title: "Feature Enginnering for Vaginal_Microbiome_ML_Classifier"
author: "LaShanda Williams, PhD"
date: "December 6, 2025"
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: cosmo
---

```{r}
library(readxl)
library(tidyverse)
library(ALDEx2)
library(vegan)
```


```{r}
otu_file <- "../../01_data/raw/zmeh_a_11816030_sm0001.xlsx"
meta_file <- "../../01_data/raw/zmeh_a_11816030_sm0002.xlsx"

SAMPLE_ID_COLUMN_META <- "#SampleID"
```

```{r}
df_otu <- read_excel(otu_file, col_names = TRUE, skip = 1)
df_meta <- read_excel(meta_file, col_names = TRUE, skip = 1)

names(df_otu)[1] <- "OTU_ID"
names(df_meta)[1] <- "Sample_ID"

```

```{r}
otu_counts_final <- df_otu %>%
    column_to_rownames("OTU_ID") %>%
    mutate(across(everything(), as.numeric)) %>%
    mutate(across(everything(), ~replace_na(., 0))) %>%
    mutate(across(everything(), as.integer))

STATUS_PATTERN <- "[a-z]+$"

metadata_aligned <- df_meta %>%
    filter(time == 0) %>%
    mutate(Status_Code = str_extract(Sample_ID, pattern = STATUS_PATTERN)) %>%
    mutate(Status_Code = tolower(Status_Code)) %>%
    mutate(Sample_ID = trimws(Sample_ID)) %>%
    column_to_rownames("Sample_ID")
```


```{r}
common_samples <- intersect(colnames(otu_counts_final), rownames(metadata_aligned))
otu_counts_final <- otu_counts_final[, common_samples]
metadata_aligned <- metadata_aligned[common_samples, ]
```


```{r}
min_prevalence <- 5 
min_count <- 10    

otus_to_keep <- rowSums(otu_counts_final > 0) >= min_prevalence &
                rowSums(otu_counts_final) >= min_count

otu_counts_final <- otu_counts_final[otus_to_keep, ]

# --- Remove zero-sum samples ---
zero_samples <- which(colSums(otu_counts_final) == 0)
if (length(zero_samples) > 0) {
    otu_counts_final <- otu_counts_final[, -zero_samples]
    metadata_aligned <- metadata_aligned[colnames(otu_counts_final), ]
}

cat("Final Aligned Samples:", ncol(otu_counts_final), "\n")
cat("Final Features Remaining:", nrow(otu_counts_final), "\n")
```

```{r}
condition_vector <- metadata_aligned[colnames(otu_counts_final), "Status_Code"]

clr_results <- aldex.clr(
    reads = otu_counts_final,
    conds = as.character(condition_vector),
    mc.samples = 128,      # proper MC sampling
    denom = "all",
    verbose = FALSE,
    useMC = TRUE           # <- FORCE Monte Carlo sampling
)

clr_mc <- slot(clr_results, "analysisData")

if (length(clr_mc) < 1) stop("ALDEx2 returned zero CLR Monte Carlo samples.")

num_samples <- length(clr_mc)
num_features <- nrow(clr_mc[[1]])  # number of features
clr_feature_matrix <- matrix(NA, nrow = num_samples, ncol = num_features)

sample_ids <- names(clr_mc)
rownames(clr_feature_matrix) <- sample_ids

for (i in seq_along(clr_mc)) {
  clr_feature_matrix[i, ] <- rowMeans(clr_mc[[i]])
}

colnames(clr_feature_matrix) <- paste0("CLR_", rownames(clr_mc[[1]]))
clr_feature_matrix <- as.data.frame(clr_feature_matrix)




```


```{r}
otu_samples_in_rows <- as.data.frame(t(otu_counts_final))

alpha_diversity <- data.frame(
    SampleID = rownames(otu_samples_in_rows),
    Shannon_Index = diversity(otu_samples_in_rows, index = "shannon"),
    Observed_Richness = specnumber(otu_samples_in_rows)
)

rownames(alpha_diversity) <- alpha_diversity$SampleID
alpha_diversity$SampleID <- NULL
```

```{r}
metadata_to_join <- metadata_aligned %>% 
  rownames_to_column("SampleID")

final_features_temp <- clr_feature_matrix %>%
  rownames_to_column("SampleID") %>%
  inner_join(alpha_diversity %>% rownames_to_column("SampleID"), by = "SampleID")

df_full_features_with_status <- final_features_temp %>%
    inner_join(metadata_to_join, by = "SampleID") %>%
    column_to_rownames("SampleID")
```

```{r}
df_bcont <- df_full_features_with_status %>% filter(Status_Code == "bcont")
df_bbv   <- df_full_features_with_status %>% filter(Status_Code == "bbv")
df_bvvc  <- df_full_features_with_status %>% filter(Status_Code == "bvvc")
```

```{r}
write.csv(df_full_features_with_status, 
          file = "../../01_data/processed/final_ml_feature_matrix.csv", 
          row.names = TRUE)
```

```{r}
# =========================================================================
# Final Statistical Interpretation Script (R)
# =========================================================================

# 1. Load Libraries and Data 
# Ensure you have these packages installed: install.packages(c("tidyverse", "ggplot2", "stats"))
library(tidyverse)
library(ggplot2)
library(stats) # For kruskal.test and prcomp

# --- NOTE: Load the final feature matrix from the Python step ---
# Assuming the file is named: final_ml_feature_matrix.csv
# df_full_features_with_status <- read_csv("../../01_data/processed/final_ml_feature_matrix.csv") %>% 
#   rename(SampleID = '...1') %>%
#   column_to_rownames("SampleID")

# --- ASSUMPTION: The df_full_features_with_status object is already loaded ---
# If you are running this in the same session, you already have:
# df_bcont, df_bbv, df_bvvc
# If not, run your full pipeline code up to Step 10.

df_full <- df_full_features_with_status # Use the full combined dataframe for testing

# 2. Univariate Analysis: Alpha Diversity Comparison (Kruskal-Wallis)
cat("\n--- 2. Alpha Diversity Comparison (Shannon Index) ---\n")

# Use Kruskal-Wallis (non-parametric ANOVA) to test for differences across 3 groups
shannon_test <- kruskal.test(Shannon_Index ~ Status_Code, data = df_full)

print(shannon_test)

if (shannon_test$p.value < 0.05) {
  cat("Conclusion: Shannon Index is significantly different among the three groups.\n")
  # NOTE: If significant, you would use a post-hoc test (e.g., dunn.test) 
  # to find which specific pairs (bcont vs. bbv, etc.) are different.
} else {
  cat("Conclusion: No significant difference in Shannon Index found.\n")
}

# --- Alpha Diversity Box Plot ---
p1 <- ggplot(df_full, aes(x = Status_Code, y = Shannon_Index, fill = Status_Code)) +
  geom_boxplot() +
  labs(title = "Shannon Diversity by Clinical Status",
       x = "Clinical Status",
       y = "Shannon Index") +
  theme_minimal()
print(p1)
# ggsave("shannon_boxplot.png", plot = p1, width = 6, height = 4)


# 3. Differential Abundance Analysis (CLR Biomarkers)
cat("\n--- 3. Differential Abundance: Top CLR Biomarker (CLR_1) ---\n")

# Test the most important feature found by SHAP/ML: CLR_1
clr1_test <- kruskal.test(CLR_1 ~ Status_Code, data = df_full)
print(clr1_test)

if (clr1_test$p.value < 0.05) {
  cat("Conclusion: CLR_1 abundance is significantly different among the three groups.\n")
} else {
  cat("Conclusion: CLR_1 abundance is NOT significantly different (unlikely).\n")
}

# --- Biomarker Box Plot ---
p2 <- ggplot(df_full, aes(x = Status_Code, y = CLR_1, fill = Status_Code)) +
  geom_boxplot() +
  labs(title = "Relative Abundance (CLR_1) by Clinical Status",
       x = "Clinical Status",
       y = "CLR_1 Value (Relative Abundance)") +
  theme_minimal()
print(p2)
# ggsave("clr1_boxplot.png", plot = p2, width = 6, height = 4)


# 4. Multivariate Analysis: Principal Component Analysis (PCA)
cat("\n--- 4. Multivariate Analysis: Principal Component Analysis (PCA) ---\n")

clr_cols <- grep("^CLR_", names(df_full), value = TRUE)
df_pca_input <- df_full[, clr_cols]

# Perform PCA
pca_result <- prcomp(df_pca_input, scale. = TRUE)

# Prepare data for plotting (extract PC scores and merge status code)
pca_scores <- as.data.frame(pca_result$x) %>%
  # --- CRITICAL FIX: Explicitly call dplyr::select to avoid masking error ---
  dplyr::select(PC1, PC2) %>%
  # Merge the status code back for coloring the plot
  mutate(Status_Code = df_full$Status_Code)

# Prepare data for plotting (extract PC scores and merge status code)
pca_scores <- as.data.frame(pca_result$x) %>%
  select(PC1, PC2) %>%
  # Merge the status code back for coloring the plot
  mutate(Status_Code = df_full$Status_Code)

# Calculate variance explained for axis labels
variance_explained <- summary(pca_result)$importance[2, 1:2]
pc1_var <- paste0("PC1 (", round(variance_explained[1] * 100, 1), "%)")
pc2_var <- paste0("PC2 (", round(variance_explained[2] * 100, 1), "%)")

# --- PCA Scatter Plot ---
p3 <- ggplot(pca_scores, aes(x = PC1, y = PC2, color = Status_Code)) +
  geom_point(size = 3, alpha = 0.7) +
  stat_ellipse(geom = "polygon", alpha = 0.1, aes(fill = Status_Code)) + # Add confidence ellipses
  labs(title = "PCA of CLR Microbiome Profiles",
       subtitle = "Color coded by Clinical Status",
       x = pc1_var,
       y = pc2_var) +
  theme_minimal()
print(p3)
ggsave("pca_plot.png", plot = p3, width = 7, height = 5)

cat("\nAnalysis complete. Examine the PCA plot for visual separation of the three groups.")
```




